{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// amd/src/actions.js\nimport {get_string as getString} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\n/**\n * Mapa de acciones: nombre -> handler(ev, el)\n * @type {Map<string, Function>}\n */\nconst registry = new Map();\n\n/**\n * Delegación de eventos: escucha en `root` y, si el objetivo o un ancestro\n * coincide con `selector`, ejecuta `handler(ev, targetMatch)`.\n * @param {HTMLElement} root     Contenedor raíz donde delegar\n * @param {string} selector      Selector a matchear (con closest)\n * @param {string} type          Tipo de evento (p.ej., 'click')\n * @param {(ev:Event, el:HTMLElement)=>void} handler  Manejador\n * @returns {void}\n */\nfunction on(root, selector, type, handler) {\n  root.addEventListener(type, (ev) => {\n    const origin = /** @type {Element} */(ev.target instanceof Element ? ev.target : root);\n    const target = origin.closest(selector);\n    if (!target || !root.contains(target)) {\n      return;\n    }\n    handler(ev, /** @type {HTMLElement} */(target));\n  });\n}\n\n/**\n * Abre un enlace en nueva pestaña. Usa href o data-url.\n * Marca aria-busy brevemente como feedback.\n * @param {MouseEvent} ev\n * @param {HTMLElement} el\n * @returns {void}\n */\nfunction handleOpenLink(ev, el) {\n  // Si es <a> con href, dejamos que el browser lo haga,\n  // pero añadimos un pequeño “busy”/tracking si quieres.\n  // Si NO quieres prevenir, comenta la línea de preventDefault.\n  ev.preventDefault();\n\n  el.setAttribute('aria-busy', 'true');\n  // Si el elemento no tiene href (ej. <button>), abrimos data-url:\n  const url = el.getAttribute('href') || el.dataset.url;\n  if (url) {\n    window.open(url, '_blank', 'noopener');\n  }\n  // Quita busy luego de un tick\n  setTimeout(() => el.removeAttribute('aria-busy'), 300);\n}\n\n/**\n * Copia el contenido del cuadro de respuesta al portapapeles.\n * - data-target: selector del contenedor (ej. \"#ai-response\")\n * - data-copy: \"text\" (por defecto) o \"html\"\n *   - En ambos modos se eliminan spans .lsc-caret antes de copiar.\n *\n * @param {MouseEvent} _ev\n * @param {HTMLElement} el\n * @returns {void}\n */\nasync function handleCopyHtml(_ev, el) {\n  const sel = el.dataset.target || '';\n  const node = sel ? document.querySelector(sel) : null;\n  if (!node) {\n    return;\n  }\n\n  // Clonamos para poder limpiar elementos auxiliares (caret, etc.)\n  const clone = node.cloneNode(true);\n  const carets = clone.querySelectorAll('.lsc-caret');\n  carets.forEach(c => c.remove());\n\n  const mode = (el.dataset.copy === 'html') ? 'html' : 'text';\n  const content = (mode === 'html')\n    ? clone.innerHTML\n    : (clone.innerText || clone.textContent || '');\n\n  navigator.clipboard.writeText(content)\n    .then(() => {\n      // feedback opcional: cambiar el texto del botón brevemente\n      const btn = el.querySelector('[data-action=\"copy-html\"]');\n      if (!btn) {return;}\n\n      const originalHTML = btn.innerHTML;\n      btn.textContent = '✔';\n      setTimeout(() => { btn.textContent = originalHTML; }, 1200);\n    })\n    .catch(() => {\n      // fallback opcional (silencioso)\n    });\n}\n\n\n\n// --- STREAM MOCK + TYPEWRITER -----------------------------------------------\n\n/**\n * Inserta y devuelve un cursor visual (caret) al final del elemento destino.\n * Se usa para simular escritura en vivo.\n *\n * @param {HTMLElement} el - Contenedor donde se añadirá el caret.\n * @returns {HTMLSpanElement} caret - El nodo <span> insertado con la clase \"lsc-caret\".\n */\nfunction addCaret(el) {\n  const caret = document.createElement('span');\n  caret.className = 'lsc-caret';\n  caret.textContent = ' ';\n  el.appendChild(caret);\n  return caret;\n}\n\n/**\n * Elimina, si existe, el cursor visual (caret) dentro del elemento destino.\n *\n * @param {HTMLElement} el - Contenedor desde el que se eliminará el caret.\n * @returns {void}\n */\nfunction removeCaret(el) {\n  const caret = el.querySelector('.lsc-caret');\n  if (caret) { caret.remove(); }\n}\n\n// Control de streams por destino (para detener si se pulsa de nuevo)\nconst streams = new WeakMap();\n\n/**\n * Escribe texto en unidades (char|word) con un intervalo.\n * @param {HTMLElement} el\n * @param {string} text\n * @param {'char'|'word'} mode\n * @param {number} speedMs\n * @returns {{stop:Function, done:Promise<void>}}\n */\nexport function typewriter(el, text, mode, speedMs) {\n  const caret = addCaret(el);\n  const units = mode === 'char' ? text.split('') : text.split(/\\s+/);\n  let i = 0;\n  let stopped = false;\n  el.innerHTML = '';\n  el.appendChild(caret);\n\n  const done = new Promise((resolve) => {\n    const timer = setInterval(() => {\n      if (stopped) {\n        clearInterval(timer);\n        removeCaret(el);\n        resolve();\n        return;\n      }\n      if (i >= units.length) {\n        clearInterval(timer);\n        removeCaret(el);\n        resolve();\n        return;\n      }\n      const chunk = units[i++];\n      caret.insertAdjacentText('beforebegin', mode === 'word' ? (chunk + ' ') : chunk);\n    }, Math.max(10, speedMs || 30));\n    streams.set(el, { stop: () => { stopped = true; } });\n  });\n\n  return { stop() { const s = streams.get(el); if (s) { s.stop(); streams.delete(el); } }, done };\n}\n\n/**\n * Obtiene una respuesta generada por IA para un certificado/curso y red social dada,\n * utilizando la llamada AJAX `local_socialcert_get_ai_response`.\n *\n * La función envía un payload con `certname`, el curso fijo \"Curso de Python\",\n * la organización y la red social, y resuelve con el texto de la respuesta (`reply`)\n * devuelta por el backend.\n *\n * @function ai_response\n * @async\n * @param {string} certname - Nombre del certificado (o del estudiante) a incluir en el prompt.\n * @param {string} course - Nombre del certificado (o del estudiante) a incluir en el prompt.\n * @param {string} org - Nombre de la organización o institución emisora.\n * @param {string} socialmedia - Red social objetivo (p. ej., \"LinkedIn\") o lista de redes.\n * @returns {Promise<string>} Promesa que se resuelve con el contenido textual de la respuesta de IA.\n * @throws {SyntaxError} Si el JSON devuelto por el backend no es válido.\n * @throws {Error} Si la llamada AJAX falla por cualquier motivo (se notificará con `Notification.exception`).\n *\n * @example\n * ai_response(\"Certificado de Analítica\", \"BUEN DATA\", \"LinkedIn\")\n *   .then((reply) => {\n *     console.log(\"Respuesta IA:\", reply);\n *   })\n *   .catch((err) => {\n *     console.error(\"Error obteniendo la respuesta de IA:\", err);\n *   });\n */\nfunction ai_response (certname, course, org, socialmedia) {\n  return new Promise((resolve, reject) => {\n    Ajax.call([{\n      methodname: 'local_socialcert_get_ai_response',\n      args: {\n        body: {\n          certname: certname,\n          course: course,\n          org: org,\n          socialmedia: socialmedia\n        }\n      },\n    }])[0].then((response) => {\n      try {\n        const parsed = JSON.parse(response.json);\n        return resolve(parsed.reply);\n      } catch (e) {\n        reject(e);\n      }\n    }).catch((err) => {\n      Notification.exception(err);\n      reject(err);\n    });\n  });\n}\n\n\n/**\n * Ejecuta/Detiene la “IA” (streaming).\n * Lee data-target, data-mode (\"char\"|\"word\"), data-speed (ms).\n * @param {MouseEvent} ev\n * @param {HTMLElement} btn\n */\nexport function runAiHandler(ev, btn) {\n  ev.preventDefault();\n\n  // Localiza el destino\n  const sel = btn.dataset.target;\n  let target = null;\n  if (sel) {\n    target = document.querySelector(sel);\n  } else {\n    const wrap = btn.closest('.lsc-response-wrap');\n    target = wrap ? wrap.querySelector('.lsc-response') : null;\n  }\n  if (!target) { return; }\n\n  // Si ya hay stream en ese destino: detener y restaurar\n  if (streams.has(target)) {\n    const s = streams.get(target);\n    if (s && s.stop) { s.stop(); }\n    btn.disabled = false;\n    btn.textContent = getString('airesponsebtn', 'local_socialcert');\n    return;\n  }\n\n  // Preparar UI\n  const mode = (btn.dataset.mode === 'char') ? 'char' : 'word';\n  const speed = parseInt(btn.dataset.speed || '40', 10);\n  const certname = btn.dataset.certname || '';\n  const course = btn.dataset.course || '';\n  const org = btn.dataset.org || '';\n  const socialmedia = btn.dataset.socialmedia || '';\n  const id_servicio = btn.dataset.id_servicio || '';\n  const original = btn.textContent;\n  btn.disabled = true;\n  btn.textContent = 'Generating';\n  target.setAttribute('aria-busy', 'true');\n  target.setAttribute('role', 'status');\n\n  const loader = document.getElementById('ai-card');\n  const copyBtn = document.getElementById('copyBtn');\n\n  ai_response(certname, course, org, socialmedia, id_servicio).then((fulltext) => {\n    loader.classList.add('hidden');\n    loader.setAttribute('aria-busy', 'false');\n    const stream = typewriter(target, fulltext , mode, speed);\n    stream.done.then(() => {\n      btn.disabled = false;\n      btn.textContent = original;\n      target.removeAttribute('aria-busy');\n      streams.delete(target);\n    })\n    .finally(() => {\n      copyBtn.hidden=false;\n    });\n  }).catch(() => {\n    btn.disabled = false;\n    btn.textContent = original;\n    target.removeAttribute('aria-busy');\n  });\n}\n\n\n/**\n * Registra una acción para usar con data-action=\"name\".\n * @param {string} name\n * @param {(ev:Event, el:HTMLElement)=>void} fn\n * @returns {void}\n */\nexport function register(name, fn) { registry.set(name, fn); }\n\n\n/**\n * Punto de entrada: registra handlers base y activa la delegación de clicks.\n * @returns {void}\n */\nexport function init() {\n  const root = document.querySelector('.local-socialcert');\n  if (!root) {\n    return;\n  }\n\n  // Registra acciones base\n  register('open-link', handleOpenLink);\n  register('copy-html', handleCopyHtml);\n  register('run-ai', runAiHandler);\n\n  // Delegación única para todos los clicks con data-action\n  on(root, '[data-action]', 'click', (ev, el) => {\n    const action = el.dataset.action;\n    const fn = registry.get(action);\n    if (fn) {\n      fn(ev, el);\n    }\n  });\n\n}\n"],"names":["root","document","querySelector","register","handleOpenLink","handleCopyHtml","runAiHandler","selector","type","handler","addEventListener","ev","target","Element","closest","contains","on","el","action","dataset","fn","registry","get","Map","preventDefault","setAttribute","url","getAttribute","window","open","setTimeout","removeAttribute","_ev","sel","node","clone","cloneNode","querySelectorAll","forEach","c","remove","content","copy","innerHTML","innerText","textContent","navigator","clipboard","writeText","then","btn","originalHTML","catch","removeCaret","caret","streams","WeakMap","typewriter","text","mode","speedMs","createElement","className","appendChild","addCaret","units","split","i","stopped","stop","s","delete","done","Promise","resolve","timer","setInterval","clearInterval","length","chunk","insertAdjacentText","Math","max","set","wrap","has","disabled","speed","parseInt","certname","course","org","socialmedia","original","id_servicio","loader","getElementById","copyBtn","reject","call","methodname","args","body","response","parsed","JSON","parse","json","reply","e","err","exception","ai_response","fulltext","classList","add","finally","hidden","name"],"mappings":"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"}