{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Plugin version and other meta-data are defined here.\n *\n * @package\n * @copyright   2025 Manuel Bojaca <manuel@buendata.com>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Local SocialCert — frontend helpers.\n *\n * Responsibilities:\n * - Lightweight event delegation utility for click actions.\n * - Handlers for: opening external links, copying generated text, and AI “typewriter” effect.\n * - Triggering the AI request and streaming the response into the DOM.\n * - Public API: { init, register, runAiHandler, typewriter }.\n *\n * Notes:\n * - This module is loaded via $PAGE->requires->js_call_amd('local_socialcert/actions', 'init').\n * - The HTML is rendered by the Mustache template and provides the data-* hooks.\n */\n\nimport {get_string as getString} from 'core/str';\nimport Ajax from 'core/ajax';\n\n/* ============================================================================\n * Action registry\n * ==========================================================================*/\n\n/**\n * Action registry mapping: actionName -> handler(event, element).\n * Handlers are registered once in {@link init} and invoked via delegation.\n * @type {Map<string, Function>}\n */\nconst registry = new Map();\n\n/* ============================================================================\n * Event delegation\n * ==========================================================================*/\n\n/**\n * Simple event delegation helper.\n * Listens on a root element and, when the event target or an ancestor matches\n * the selector, calls the provided handler with the matched element.\n *\n * @param {HTMLElement} root   Root container where the listener is attached.\n * @param {string} selector    CSS selector to match using Element.closest().\n * @param {string} type        Event type (e.g., \"click\").\n * @param {(ev: Event, el: HTMLElement) => void} handler  Callback invoked with the event and the matched element.\n * @returns {void}\n */\nfunction on(root, selector, type, handler) {\n  root.addEventListener(type, (ev) => {\n    const origin = /** @type {Element} */(ev.target instanceof Element ? ev.target : root);\n    const target = origin.closest(selector);\n    if (!target || !root.contains(target)) {\n      return;\n    }\n    handler(ev, /** @type {HTMLElement} */(target));\n  });\n}\n\n/* ============================================================================\n * Handlers: open link / copy to clipboard\n * ==========================================================================*/\n\n/**\n * Opens a link in a new tab (using element href or data-url) and briefly sets aria-busy for feedback.\n *\n * @param {MouseEvent} ev\n * @param {HTMLElement} el Element with an href or data-url attribute.\n * @returns {void}\n */\nfunction handleOpenLink(ev, el) {\n\n  ev.preventDefault();\n\n  el.setAttribute('aria-busy', 'true');\n\n  const url = el.getAttribute('href') || el.dataset.url;\n\n  if (url) {\n    window.open(url, '_blank', 'noopener');\n  }\n\n  setTimeout(() => el.removeAttribute('aria-busy'), 300);\n}\n\n/**\n * Copies the content of a target node to the clipboard.\n * - data-target: selector pointing to the container (e.g., \"#ai-response\").\n * - data-copy: \"text\" (default) or \"html\".\n *   - In both modes, temporary caret spans (.lsc-caret) are removed before copying.\n *\n * @param {MouseEvent} _ev\n * @param {HTMLElement} el Button element with data-target (and optional data-copy).\n * @returns {void}\n */\nasync function handleCopyHtml(_ev, el) {\n  const sel = el.dataset.target || '';\n  const node = sel ? document.querySelector(sel) : null;\n  if (!node) {\n    return;\n  }\n\n  const clone = node.cloneNode(true);\n  const carets = clone.querySelectorAll('.lsc-caret');\n  carets.forEach(c => c.remove());\n\n  const mode = (el.dataset.copy === 'html') ? 'html' : 'text';\n  const content = (mode === 'html')\n    ? clone.innerHTML\n    : (clone.innerText || clone.textContent || '');\n\n  navigator.clipboard.writeText(content)\n    .then(() => {\n\n      const btn = el.querySelector('[data-action=\"copy-html\"]');\n\n      if (!btn) {return;}\n\n      const originalHTML = btn.innerHTML;\n      btn.textContent = '✔';\n      setTimeout(() => { btn.textContent = originalHTML; }, 1200);\n    })\n    .catch(() => {\n\n    });\n}\n\n/* ============================================================================\n * Typewriter (stream mock) utilities\n * ==========================================================================*/\n\n/**\n * Inserts a visual caret at the end of the target element and returns it.\n * Used to simulate live typing.\n *\n * @param {HTMLElement} el Target container where the caret is appended.\n * @returns {HTMLSpanElement} The inserted <span> with class \"lsc-caret\".\n */\nfunction addCaret(el) {\n  const caret = document.createElement('span');\n  caret.className = 'lsc-caret';\n  caret.textContent = ' ';\n  el.appendChild(caret);\n  return caret;\n}\n\n/**\n * Removes the visual caret (if present) from a given element.\n *\n * @param {HTMLElement} el Container to clean up.\n * @returns {void}\n */\nfunction removeCaret(el) {\n  const caret = el.querySelector('.lsc-caret');\n  if (caret) { caret.remove(); }\n}\n\n\n/**\n * Maps an error message returned by the backend to a plugin lang key.\n *\n * Detection is case-insensitive and based on simple text matches:\n * - Contains \"insufficient ai credits\"  -> returns `errors[0]` (e.g., \"tokenserror\")\n * - Contains \"your license is not allowed\" or \"manage credits\" -> returns `errors[1]` (e.g., \"licenseerror\")\n * - Otherwise -> returns `errors[2]` (e.g., \"genericerror\")\n *\n * @param {string} message - Error text returned by the service (may include HTML).\n * @param {string[]} errors - Array of lang keys in the order:\n *   [0] = key for insufficient credits (e.g., \"tokenserror\"),\n *   [1] = key for not-allowed license (e.g., \"licenseerror\"),\n *   [2] = generic key (e.g., \"genericerror\").\n * @returns {string} The corresponding lang key based on the message content.\n */\nfunction mapErrorToLangKey(message, errors) {\n  const msg = String(message || '').toLowerCase();\n\n  if (msg.includes('insufficient ai credits')) {\n    return errors[0];\n  }\n\n  if (\n    msg.includes('your license is not allowed') ||\n    msg.includes('manage credits')\n  ) {\n    return errors[1];\n  }\n\n  return errors[2];\n}\n\n/**\n * Tracks active streams per target so we can stop/replace them.\n * @type {WeakMap<HTMLElement, {stop: Function}>}\n */\nconst streams = new WeakMap();\n\n/**\n * Streams text into an element in \"char\" or \"word\" units with a configurable delay.\n *\n * @param {HTMLElement} el   Target element to receive the text.\n * @param {string} text      Full text to stream.\n * @param {'char'|'word'} mode Unit size used while streaming.\n * @param {number} speedMs   Interval between units (ms).\n * @returns {{stop: Function, done: Promise<void>}} Control handle with a stop() method and a completion promise.\n */\nexport function typewriter(el, text, mode, speedMs) {\n  const isHTML = /<[^>]+>/.test(text); // ← detección simple\n\n  // Rama HTML: render directo para que <a> sea clickeable\n  if (isHTML) {\n    el.innerHTML = text;\n    return {\n      stop() { /* nada que parar */ },\n      done: Promise.resolve()\n    };\n  }\n\n  // Rama TEXTO: tu implementación original\n  const caret = addCaret(el);\n  const units = mode === 'char' ? text.split('') : text.split(/\\s+/);\n  let i = 0;\n  let stopped = false;\n  el.innerHTML = '';\n  el.appendChild(caret);\n\n  const done = new Promise((resolve) => {\n    const timer = setInterval(() => {\n      if (stopped) {\n        clearInterval(timer);\n        removeCaret(el);\n        resolve();\n        return;\n      }\n      if (i >= units.length) {\n        clearInterval(timer);\n        removeCaret(el);\n        resolve();\n        return;\n      }\n      const chunk = units[i++];\n      caret.insertAdjacentText('beforebegin', mode === 'word' ? (chunk + ' ') : chunk);\n    }, Math.max(10, speedMs || 30));\n    streams.set(el, { stop: () => { stopped = true; } });\n  });\n\n  return { stop() { const s = streams.get(el); if (s) { s.stop(); streams.delete(el); } }, done };\n}\n\n/* ============================================================================\n * AI request\n * ==========================================================================*/\n\n/**\n * Fetches an AI-generated response for the given context using the\n * `local_socialcert_get_ai_response` web service.\n *\n * @function ai_response\n * @async\n * @param {string} certname   Certificate (or student) name used in the prompt.\n * @param {string} course     Course name used in the prompt.\n * @param {string} org        Issuing organization name.\n * @param {string} socialmedia Target social network (e.g., \"LinkedIn\").\n * @param {string[]} errorarray - Array of lang keys in the order:\n * @param {number} cmid - Course module ID.\n * @returns {Promise<string>} Resolves to the AI textual reply.\n * @throws {SyntaxError} If the backend JSON is invalid.\n * @throws {Error} If the AJAX call fails (also reported via Notification.exception).\n *\n * @example\n * ai_response(\"Analytics Certificate\", \"BUEN DATA\", \"LinkedIn\")\n *   .then(reply => console.log(\"AI reply:\", reply))\n *   .catch(err => console.error(\"AI error:\", err));\n */\nfunction ai_response (certname, course, org, socialmedia, errorarray, cmid) {\n\n  return new Promise((resolve) => {\n    Ajax.call([{\n      methodname: 'local_socialcert_get_ai_response',\n      args: {\n        body: {\n          certname: certname,\n          course: course,\n          org: org,\n          socialmedia: socialmedia,\n        },\n        cmid: cmid,\n      },\n    }])[0].then((response) => {\n      if (response.json) {\n        const parsed = JSON.parse(response.json);\n        return resolve({fulltext: parsed.reply, done: true});\n      } else {\n        const errormsg = mapErrorToLangKey(response.message, errorarray);\n        return resolve({fulltext: errormsg, done: false});\n      }\n    }).catch(() => {\n      return resolve({ fulltext: errorarray[2], done: false });\n    });\n  });\n}\n\n/* ============================================================================\n * Action: run AI\n * ==========================================================================*/\n\n/**\n * Starts/stops the “AI” streaming flow.\n * Reads data attributes from the trigger button:\n *  - data-target: CSS selector for the output node.\n *  - data-mode: \"char\" | \"word\" (streaming unit).\n *  - data-speed: interval in ms.\n *\n * Also manages a loader, ARIA states, and reveals the Copy button when done.\n *\n* @param {number} cmid\n * @returns {(ev: MouseEvent, btn: HTMLElement) => void}\n */\nexport function runAiHandler(cmid) {\n  return function(ev, btn) {\n    ev.preventDefault();\n    const sel = btn.dataset.target;\n    let target = null;\n    if (sel) {\n      target = document.querySelector(sel);\n    } else {\n      const wrap = btn.closest('.lsc-response-wrap');\n      target = wrap ? wrap.querySelector('.lsc-response') : null;\n    }\n    if (!target) { return; }\n\n    if (streams.has(target)) {\n      const s = streams.get(target);\n      if (s && s.stop) { s.stop(); }\n      btn.disabled = false;\n      btn.textContent = getString('airesponsebtn', 'local_socialcert');\n      return;\n    }\n\n    const mode = (btn.dataset.mode === 'char') ? 'char' : 'word';\n    const speed = parseInt(btn.dataset.speed || '40', 10);\n    const certname = btn.dataset.certname || '';\n    const course = btn.dataset.course || '';\n    const org = btn.dataset.org || '';\n    const socialmedia = btn.dataset.socialmedia || '';\n    // const id_servicio = btn.dataset.id_servicio || '';\n    const original = btn.textContent;\n    btn.disabled = true;\n    btn.textContent = 'Generating';\n    target.setAttribute('aria-busy', 'true');\n    target.setAttribute('role', 'status');\n\n    const loader = document.getElementById('ai-card');\n    const copyBtn = document.getElementById('copyBtn');\n    const errorLicense = btn.dataset.errorlicense;\n    const errorCredits = btn.dataset.errorcredits;\n    const errorGeneric = btn.dataset.errorgeneric;\n    const errorarray = [\n      errorCredits,\n      errorLicense,\n      errorGeneric\n    ];\n    let streamtext = '';\n\n    copyBtn.hidden=true;\n\n    ai_response(certname, course, org, socialmedia, errorarray, cmid).then((response) => {\n      streamtext = response.fulltext;\n      if(response.done) { copyBtn.hidden=false; }\n    }).catch(() => {\n      streamtext = errorGeneric;\n    }).finally(() => {\n      loader.classList.add('hidden');\n      loader.setAttribute('aria-busy', 'false');\n      const stream = typewriter(target, streamtext, mode, speed);\n      stream.done.then(() => {\n        btn.disabled = false;\n        btn.textContent = original;\n        target.removeAttribute('aria-busy');\n        streams.delete(target);\n      });\n    });\n  };\n}\n\n\n/* ============================================================================\n * Public API\n * ==========================================================================*/\n\n/**\n * Registers an action handler that can be invoked via data-action=\"name\".\n *\n * @param {string} name\n * @param {(ev: Event, el: HTMLElement) => void} fn\n * @returns {void}\n */\nexport function register(name, fn) { registry.set(name, fn); }\n\n/**\n * Entry point: registers base actions and sets up click delegation.\n * Called once when the AMD module is loaded.\n * @param {Object} cmid Initialization options.\n * @returns {void}\n */\nexport function init(cmid) {\n  const root = document.querySelector('.local-socialcert');\n  if (!root) {\n    return;\n  }\n\n  register('open-link', handleOpenLink);\n  register('copy-html', handleCopyHtml);\n  register('run-ai', runAiHandler(cmid));\n\n  on(root, '[data-action]', 'click', (ev, el) => {\n    const action = el.dataset.action;\n    const fn = registry.get(action);\n    if (fn) {\n      fn(ev, el);\n    }\n  });\n}\n"],"names":["cmid","root","document","querySelector","register","handleOpenLink","handleCopyHtml","runAiHandler","selector","type","handler","addEventListener","ev","target","Element","closest","contains","on","el","action","dataset","fn","registry","get","Map","preventDefault","setAttribute","url","getAttribute","window","open","setTimeout","removeAttribute","_ev","sel","node","clone","cloneNode","querySelectorAll","forEach","c","remove","content","copy","innerHTML","innerText","textContent","navigator","clipboard","writeText","then","btn","originalHTML","catch","removeCaret","caret","streams","WeakMap","typewriter","text","mode","speedMs","test","stop","done","Promise","resolve","createElement","className","appendChild","addCaret","units","split","i","stopped","s","delete","timer","setInterval","clearInterval","length","chunk","insertAdjacentText","Math","max","set","ai_response","certname","course","org","socialmedia","errorarray","call","methodname","args","body","response","json","parsed","JSON","parse","fulltext","reply","errormsg","message","errors","msg","String","toLowerCase","includes","mapErrorToLangKey","wrap","has","disabled","speed","parseInt","original","loader","getElementById","copyBtn","errorLicense","errorlicense","errorCredits","errorcredits","errorGeneric","errorgeneric","streamtext","hidden","finally","classList","add","name"],"mappings":"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"}